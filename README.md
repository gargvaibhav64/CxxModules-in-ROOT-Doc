This is a repository to collect all knowledge about C++ modules while I was doing an internship at CERN.

- CMSSW.md is a detailed introduction for building CMSSW software.
- future_todo.md is to give remaining works that can be done in the future.
- rootcling_impl.md is a detailed explaination of module related part of rootcling.
- rootcling_impl.md is a detailed explaination of module related part of TCling interface.

Please read TCling.md first if you're new to ROOT and C++ Modules.

### Table of contents
- [Available online documents](https://github.com/yamaguchi1024/cxxmodule-doc#available-online-documents)
   - [Publications of ROOT C++ Modules](https://github.com/yamaguchi1024/cxxmodule-doc#publications-of-root-c-modules)
   - [Resources for C++ Modules in general](https://github.com/yamaguchi1024/cxxmodule-doc#resources-for-c-modules-in-general)
   - [Resources for ROOT](https://github.com/yamaguchi1024/cxxmodule-doc#resources-for-root)
- [Useful vocabraries](https://github.com/yamaguchi1024/cxxmodule-doc#useful-vocabraries)
- [Features that Interpreter needs to support](https://github.com/yamaguchi1024/cxxmodule-doc#features-that-interpreter-needs-to-support)

### Overview
ROOT has a C++ interpreter, Cling, used in its backend. C++ Modules is a mechanism to accelarate compilation time of C++ code in general, but the benefit of compilation time improvement can be turned into runtime performance improvement as we have C++ **interpreter**. Cling uses LLVM/Clang as its backend, and C++ Module implementation in ROOT heavily relies on Clang APIs.

In ROOT, we generate ROOT pcms at compilation time of ROOT. PCMs are generated by rootcling, which is a ROOT dictionary generator. The modulemap file serves as a definition file of modules, so that rootcling can reuse pcms when generating another pcm. We generate one pcm for one library, that is for example, Core.pcm corresponds to libCore.so and so on.

### Available online documents
#### Publications of ROOT C++ Modules
- https://arxiv.org/abs/1812.03992
- https://cds.cern.ch/record/2296793/files/pdf.pdf
- https://github.com/yamaguchi1024/yamaguchi1024.github.io/blob/master/pdf/modules.pdf
- https://github.com/yamaguchi1024/yamaguchi1024.github.io/blob/master/pdf/chep.pdf

#### Resources for C++ Modules in general
- https://clang.llvm.org/doxygen/classclang_1_1Module.html
- https://clang.llvm.org/docs/Modules.html

#### Resources for ROOT
- ROOT coding convention: https://root.cern.ch/coding-conventions

### Useful vocabraries
- Modules - C++ Modules, implented in Clang, it's the same word when we say "cxxmodules". When we just say "modules", it often means "runtime C++ modules"
- PCM - "Pre Compiled Modules". AST file of C++ Modules
- PCH - "Pre Compiled Headers". Header optimization before C++ Modules.
- rdict pcm - Another runtime optimization, which has nothing to do with C++ Modules. It is an I/O optimization.
- preloading - It refers to preloading of all PCMs at ROOT startup time. See TCling.md for more details.
- dictionary generation - Often refers to rootcling or genreflex (genreflex is a wrapper of rootcling), which generates "dictionary" (eg. G__Core.cxx), rootmap, and PCM.
- rootmap files - This is a file generated by rootcling, using a information from Linkdef files. Linkdef files need to be manuary maintained. rootmap files are used to enable features like "Implicit #include" described in the section above, when C++ was not implemented.

- -Druntime_cxxmodules = "Runtime" C++ Modules.
- -Dcxxmodules = "Compile time" C++ Modules.
These two must be strictly distinguished.

### Features that Interpreter needs to support

These features are sort of "C++ superset support in ROOT". Cling supports them in order to make users' life easier.

- Implicit #include
```
root[] vector<int> v = {1, 2, 3} // works
```
You don't need to include header in ROOT

- Auto auto
```
root[] i = 12 // Interpreted as "auto i = 12"
```

- using namespace std
```
root[] string s; // Instead of std::string
```

- Eval print
```
root[] 40+2 // without semicolon at the end
(int) 42
```

- AUto loading TFile objects
```
root[] TFile::Open("tutorials/hsimple.root");
root[] hpx->Draw();
Info in <TCanvas::MakeDefCanvas>: created default TCanvas with name c1
```

- Auto loading
```
root[] TTree t;
Info in <TUnixSystem::Load>: loaded library /home/yuka/module-release/lib/libTree.so, status 0
```

- Auto parsing
```
root[] gSystem->Load("libGeom")
root[] TGeoManager g; // Triggers auto-parsing!
Info in <TInterpreter::AutoParse>: Parsing full payload for TGeoManager
```

- Ptr check
```
root[] int *p = (int*)(0x120 + 0x3);
root[] *p
ROOT_prompt_1:1:2: warning: invalid memory pointer passed to a callee: *p
```
